# AbyssAC 架构详解

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AbyssAC 人工意识系统                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         用户交互层 (Gradio UI)                        │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │   │
│  │  │   对话界面   │  │  系统设置   │  │  DMN维护    │  │  使用帮助   │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         主控制器 (AbyssAC)                            │   │
│  │   - Bootstrap流程管理                                                │   │
│  │   - DMN触发判断                                                       │   │
│  │   - 系统状态监控                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│         ┌──────────────────────────┼──────────────────────────┐            │
│         ▼                          ▼                          ▼            │
│  ┌─────────────┐          ┌─────────────────┐          ┌─────────────┐    │
│  │   X层沙盒    │          │    Y层记忆库     │          │   NNG导航图  │    │
│  │  (处理层)   │          │   (存储层)      │          │  (索引层)   │    │
│  └──────┬──────┘          └────────┬────────┘          └──────┬──────┘    │
│         │                          │                          │           │
│         ▼                          ▼                          ▼           │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                         LLM接口层                                     │  │
│  │   - Ollama本地模型    - OpenAI兼容API                                │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## X层三层沙盒详解

```
┌─────────────────────────────────────────────────────────────────┐
│                        X层三层沙盒                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  第一层：导航定位沙盒 (NavigationSandbox)                 │   │
│  │                                                         │   │
│  │   用户输入 ──► LLM决策 ◄──► NNG节点遍历                   │   │
│  │                    │                                    │   │
│  │              ┌─────┴─────┐                              │   │
│  │              ▼           ▼                              │   │
│  │           GOTO(1.2)   STAY                              │   │
│  │              │           │                              │   │
│  │              ▼           ▼                              │   │
│  │        进入子节点    结束导航                            │   │
│  │                                                         │   │
│  │   输出: 选中的节点ID列表 ["1.2.3", "2.1"]                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  第二层：记忆筛选沙盒 (MemorySelectionSandbox)            │   │
│  │                                                         │   │
│  │   选中节点 ──► 获取关联记忆摘要 ──► LLM筛选              │   │
│  │                                                         │   │
│  │   记忆#123: GIL详解...                                   │   │
│  │   记忆#456: 多线程编程...                                │   │
│  │        │                                                │   │
│  │        ▼                                                │   │
│  │   LLM: 选中记忆#123                                      │   │
│  │                                                         │   │
│  │   输出: 选中的记忆内容列表                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  第三层：上下文组装沙盒 (ContextAssemblySandbox)          │   │
│  │                                                         │   │
│  │   用户输入 + 工作记忆 + 选中记忆 ──► LLM整合              │   │
│  │                                                         │   │
│  │   === 用户当前输入 ===                                   │   │
│  │   === 工作记忆（当前对话）===                             │   │
│  │   === 相关记忆（从NNG调取）===                            │   │
│  │        │                                                │   │
│  │        ▼                                                │   │
│  │   结构化上下文                                           │   │
│  │                                                         │   │
│  │   输出: 整合后的上下文                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Y层记忆库结构

```
Y层记忆库/
│
├── id_counter.txt              # 全局ID计数器
│   内容: last_id: 0
│
├── 元认知记忆/                  # 系统自我认知
│   └── 2026/
│       └── 02/
│           └── 09/
│               └── 1.txt       # 记忆文件
│
├── 高阶整合记忆/                # 深度整合的知识
│   └── 2026/02/09/
│       └── 2.txt
│
├── 分类记忆/                    # 按价值分类
│   ├── 高价值/                  # 核心概念、关键决策
│   │   └── 2026/02/09/
│   │       └── 3.txt
│   │
│   ├── 中价值/                  # 常规知识
│   │   └── 2026/02/09/
│   │       └── 4.txt
│   │
│   └── 低价值/                  # 辅助信息
│       └── 2026/02/09/
│           └── 5.txt
│
└── 工作记忆/                    # 临时对话记忆
    └── 2026/02/09/
        ├── 6.txt               # 用户: 你好
        ├── 7.txt               # AI: 你好！有什么可以帮助你的？
        └── ...
```

## NNG导航图结构

```
NNG/
│
├── root.json                   # 根节点
│   {
│     "一级节点": ["1", "2", "3"],
│     "更新时间": "2026-02-09 00:00:00"
│   }
│
├── 1/                          # 节点1的目录
│   ├── 1.json                  # 节点1的数据
│   │   {
│   │     "定位": "1",
│   │     "内容": "Python编程",
│   │     "关联性": 80,
│   │     "置信度": 90,
│   │     "子节点": ["1.1", "1.2"],
│   │     "关联的记忆文件摘要": [...]
│   │   }
│   │
│   └── 1/                      # 节点1的子节点目录
│       ├── 1.1.json            # 节点1.1的数据
│       ├── 1.1/                # 节点1.1的子节点
│       │   └── 1.1.1.json
│       │
│       └── 1.2.json            # 节点1.2的数据
│
├── 2/                          # 节点2的目录
│   ├── 2.json
│   └── 2/
│       └── 2.1.json
│
└── 3/                          # 节点3的目录
    └── 3.json
```

## DMN五个子智能体流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    DMN（动态维护网络）                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   触发条件:                                                      │
│   - 工作记忆 ≥ 20条                                             │
│   - 导航失败 > 5次                                              │
│   - 系统空闲 > 5分钟                                            │
│   - 用户手动触发                                                 │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  Agent 1: 问题输出                                       │  │
│   │  输入: 工作记忆 + 系统状态                                │  │
│   │  输出: 待处理问题列表                                     │  │
│   └────────────────────────┬────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  Agent 2: 问题分析                                       │  │
│   │  输入: 问题列表                                           │  │
│   │  输出: 初步分析结果和建议方案                              │  │
│   └────────────────────────┬────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  Agent 3: 审查                                           │  │
│   │  判断: 完整且正确 → 通过                                  │  │
│   │       不完整/不正确 → 返回Agent 1或2                     │  │
│   └────────────────────────┬────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  Agent 4: 整理                                           │  │
│   │  输出: NNG节点JSON + 记忆内容                             │  │
│   └────────────────────────┬────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  Agent 5: 格式位置审查                                    │  │
│   │  判断: 格式正确且位置正确 → 存入系统                      │  │
│   │       否则 → 返回Agent 4重新生成                          │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Bootstrap流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        Bootstrap三阶段                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  阶段1: NNG为空                                          │   │
│  │                                                         │   │
│  │   用户输入 ──► 直接回复                                  │   │
│  │       │                                                 │   │
│  │       ▼                                                 │   │
│  │   存入工作记忆                                           │   │
│  │                                                         │   │
│  │   特点: 快速响应，无需记忆检索                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│                    工作记忆 ≥ 20条                              │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  阶段2: 首次DMN触发                                      │   │
│  │                                                         │   │
│  │   分析工作记忆 ──► 识别主题                              │   │
│  │       │                                                 │   │
│  │       ▼                                                 │   │
│  │   创建时间目录结构                                        │   │
│  │       │                                                 │   │
│  │       ▼                                                 │   │
│  │   生成首个NNG节点                                        │   │
│  │       │                                                 │   │
│  │       ▼                                                 │   │
│  │   更新root.json                                          │   │
│  │                                                         │   │
│  │   特点: 系统初始化，建立基础结构                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  阶段3: 正常运行                                         │   │
│  │                                                         │   │
│  │   用户输入 ──► 第一层沙盒: 导航定位                       │   │
│  │       │                    选中NNG节点                   │   │
│  │       ▼                                                 │   │
│  │   第二层沙盒: 记忆筛选                                    │   │
│  │       │                    选中相关记忆                  │   │
│  │       ▼                                                 │   │
│  │   第三层沙盒: 上下文组装                                  │   │
│  │       │                    整合上下文                    │   │
│  │       ▼                                                 │   │
│  │   生成回复                                               │   │
│  │                                                         │   │
│  │   特点: 完整流程，智能记忆检索                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 导航失败处理

```
┌─────────────────────────────────────────────────────────────────┐
│                      导航失败处理机制                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  失败类型:                                                       │
│                                                                 │
│  1. LLM输出格式错误                                              │
│     └── 处理: 记录错误，采用STAY默认行为                          │
│                                                                 │
│  2. GOTO目标节点不存在                                           │
│     └── 处理: 记录警告，允许跳转（可能是关联节点）                 │
│     └── 如果确实不存在，get_node返回None，导航失败                │
│                                                                 │
│  3. 达到最大导航深度（10层）                                      │
│     └── 处理: 强制停止，返回当前节点                              │
│                                                                 │
│  4. 导航超时（单次超过30秒）                                      │
│     └── 处理: 强制停止，记录导航失败                              │
│                                                                 │
│  失败处理流程:                                                    │
│                                                                 │
│   导航失败 ──► 增加失败计数器                                     │
│       │                                                         │
│       ▼                                                         │
│   记录详细日志（供DMN分析）                                        │
│       │                                                         │
│       ▼                                                         │
│   返回失败标志给主控制器                                          │
│       │                                                         │
│       ▼                                                         │
│   主控制器决定:                                                   │
│   - 降级处理: 跳过记忆筛选，直接回复                               │
│   - 或直接回复（基于当前上下文）                                   │
│       │                                                         │
│       ▼                                                         │
│   失败计数 ≥ 5 ──► 触发DMN优化任务                                │
│   （分析导航日志，优化NNG结构）                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流图

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│  用户输入 │────►│  LLM分析 │────►│ 需要记忆?│────►│  是    │
└─────────┘     └─────────┘     └────┬────┘     └───┬─────┘
                                     │              │
                                     │ 否           ▼
                                     │        ┌─────────────┐
                                     │        │ X层三层沙盒  │
                                     │        │             │
                                     │        │ 1. 导航定位  │
                                     │        │ 2. 记忆筛选  │
                                     │        │ 3. 上下文组装│
                                     │        └──────┬──────┘
                                     │               │
                                     │               ▼
                                     │        ┌─────────────┐
                                     │        │  整合的上下文 │
                                     │        └──────┬──────┘
                                     │               │
                                     └───────────────┤
                                                     ▼
                                              ┌─────────────┐
                                              │  LLM生成回复  │
                                              └──────┬──────┘
                                                     │
                                                     ▼
                                              ┌─────────────┐
                                              │  保存到工作记忆│
                                              └──────┬──────┘
                                                     │
                                                     ▼
                                              ┌─────────────┐
                                              │   返回给用户  │
                                              └─────────────┘
```

## 模块依赖关系

```
                    ┌─────────────┐
                    │   main.py   │
                    └──────┬──────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │gradio_app.py│ │  abyssac.py │ │    CLI      │
    └─────────────┘ └──────┬──────┘ └─────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
 ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
 │sandbox_layer│   │dmn_agents.py│   │memory_manager│
 │   (X层)     │   │   (DMN)     │   │   (Y层)     │
 └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
        │                  │                  │
        │         ┌────────┴────────┐         │
        │         │                 │         │
        │         ▼                 ▼         │
        │  ┌─────────────┐   ┌─────────────┐  │
        │  │nng_manager │   │llm_interface│  │
        │  │   (NNG)    │   │   (LLM)    │  │
        │  └─────────────┘   └─────────────┘  │
        │         │                 │         │
        └─────────┴─────────────────┴─────────┘
                          │
                          ▼
                   ┌─────────────┐
                   │  config.py  │
                   └─────────────┘
```
