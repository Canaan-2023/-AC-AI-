# AbyssAC 系统架构文档

## 系统概述

AbyssAC是一个基于NNG（神经网络网格）导航和Y层记忆的AI操作系统反馈系统，实现人工意识的设计方案。

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户交互层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   用户输入    │  │   对话历史    │  │   系统状态    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        X层：三层沙盒                             │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  第一层沙盒：导航定位                                     │   │
│  │  - 从root开始导航NNG结构                                 │   │
│  │  - 指令：GOTO/STAY/BACK/ROOT/DIRECT                      │   │
│  │  - 最大深度：10层                                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  第二层沙盒：记忆筛选                                     │   │
│  │  - 从NNG关联记忆中筛选                                   │   │
│  │  - 指令：记忆ID,STAY                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  第三层沙盒：上下文组装                                   │   │
│  │  - 整合记忆到回复上下文                                  │   │
│  │  - 生成结构化上下文                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
└──────────────────────────────┼──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Y层：记忆系统                             │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  分类记忆     │  │ 高阶整合记忆  │  │  元认知记忆   │          │
│  │  /高/中/低   │  │              │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐                            │
│  │  工作记忆     │  │    NNG       │                            │
│  │  (临时)      │  │   导航树      │                            │
│  └──────────────┘  └──────────────┘                            │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                        DMN：默认模式网络                         │
│                                                                 │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐        │
│  │ Agent 1 │ → │ Agent 2 │ → │ Agent 3 │ → │ Agent 4 │ →      │
│  │问题输出 │   │问题分析 │   │  审查   │   │  整理   │        │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘        │
│                                                  ↓             │
│                                           ┌─────────┐          │
│                                           │ Agent 5 │          │
│                                           │格式审查 │          │
│                                           └─────────┘          │
│                                                                 │
│  任务类型：记忆整合 | 关联发现 | 偏差审查 | 策略预演 | 概念重组   │
└─────────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 存储管理器 (StorageManager)

负责所有文件操作：
- NNG节点的CRUD操作
- 记忆文件的CRUD操作
- 日志记录
- 路径转换

```python
# NNG路径转换
1.6.5.7 → storage/nng/1/1.6/1.6.5/1.6.5.7.json

# 记忆路径
分类记忆 → storage/Y层记忆库/分类记忆/<价值>/<年>/<月>/<日>/<ID>.txt
```

### 2. LLM客户端 (LLMClient)

统一LLM调用接口：
- 支持Ollama、OpenAI等
- 同步/流式调用
- 错误处理

### 3. 三层沙盒

#### 第一层：导航定位沙盒
- 输入：用户输入、当前NNG节点
- 输出：目标NNG节点ID
- 指令集：GOTO/STAY/BACK/ROOT/DIRECT

#### 第二层：记忆筛选沙盒
- 输入：选中的NNG节点
- 输出：选中的记忆ID列表
- 指令集：记忆ID,STAY

#### 第三层：上下文组装沙盒
- 输入：选中的记忆内容
- 输出：整合后的上下文
- 用于生成最终回复

### 4. DMN系统

5个子智能体协作：

```
Agent 1 (问题输出) → Agent 2 (问题分析) → Agent 3 (审查)
                                                        ↓
Agent 5 (格式审查) ← Agent 4 (整理) ←←←←←←←←←←←←←←←←┘
```

任务触发条件：
- 工作记忆 > 20条 → 记忆整合
- 导航失败 > 5次 → 偏差审查
- 空闲 > 5分钟 → 循环任务

### 5. 会话管理器

多会话支持：
- 会话隔离
- 独立的历史记录
- 独立的沙盒状态

## 数据流

```
用户输入
    │
    ▼
┌─────────────┐
│ 第一层沙盒  │ ←→ NNG树导航
└─────────────┘
    │
    ▼
┌─────────────┐
│ 第二层沙盒  │ ←→ 记忆库
└─────────────┘
    │
    ▼
┌─────────────┐
│ 第三层沙盒  │ ←→ 上下文组装
└─────────────┘
    │
    ▼
┌─────────────┐
│  回复生成   │
└─────────────┘
    │
    ▼
  用户
```

## NNG结构

```
nng/
├── root.json
├── 1/
│   ├── 1.json
│   └── 1.1/
│       ├── 1.1.json
│       └── 1.1.1/
│           └── 1.1.1.json
├── 2/
│   ├── 2.json
│   └── 2.1/
│       └── 2.1.json
└── ...
```

## 记忆结构

```
Y层记忆库/
├── 分类记忆/
│   ├── 高价值/2026/02/14/1856.txt
│   ├── 中价值/2026/02/14/1857.txt
│   └── 低价值/2026/02/14/1858.txt
├── 高阶整合记忆/2026/02/14/1888.txt
├── 元认知记忆/2026/02/14/1900.txt
└── 工作记忆/2026/02/14/session_xxx.txt
```

## API设计

### 核心接口

| 接口 | 方法 | 描述 |
|------|------|------|
| /api/chat | POST | 发送用户输入 |
| /api/sandbox/status/{id} | GET | 获取沙盒状态 |
| /api/session/history | GET | 获取会话历史 |
| /api/nng/tree | GET | 获取NNG树 |
| /api/dmn/status | GET | 获取DMN状态 |
| /api/dmn/trigger | POST | 手动触发DMN |

### WebSocket（未来扩展）

- 实时推送沙盒状态
- 流式回复输出
- DMN进度推送

## 扩展性设计

### 1. 新的记忆类型

在 `storage.py` 中添加新的路径规则：

```python
def get_memory_path(memory_type, ...):
    if memory_type == "新类型":
        return MEMORY_PATH / "新类型" / ...
```

### 2. 新的DMN任务

在 `dmn.py` 中添加新的任务类型：

```python
class DMNTaskType(Enum):
    NEW_TASK = "new_task"
```

### 3. 新的LLM Provider

在 `llm_client.py` 中添加：

```python
async def _chat_new_provider(self, messages, temp):
    # 实现新的provider
```

## 性能优化

### 当前实现
- 文件系统存储
- 内存会话管理
- 单线程DMN

### 未来优化
- Redis缓存
- 数据库存储
- 异步DMN队列
- 向量检索

## 安全考虑

1. **输入验证**：所有用户输入经过验证
2. **路径安全**：防止目录遍历攻击
3. **会话隔离**：会话数据相互隔离
4. **日志脱敏**：敏感信息不记录

## 监控指标

- 导航成功率
- 平均导航深度
- DMN任务执行时间
- 记忆命中率
- 系统响应时间
